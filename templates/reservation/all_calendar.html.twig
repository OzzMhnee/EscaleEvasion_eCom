{% extends 'base.html.twig' %}

{% block title %}Calendrier des r√©servations{% endblock %}

{% block body %}
    <div class="parallax">
        <div class="container">
            <div class="row my-5 justify-content-center">
                <div class="card p-4 bg-light bg-opacity-50" style="max-width: 1200px;">
                    <h1>Historique des r√©servations</h1>        
                    <div class="accordion" id="accordionProducts">
                        {% for product in pagination %}
                            {% set awaitingCount = 0 %}
                            {% set confirmedCount = 0 %}
                            {% set cancelledCount = 0 %}
                            {% set finalisedCount = 0 %}
                            {% for reservation in FinalisedStatus %}
                                {% if reservation.product.id == product.id %}
                                    {% set finalisedCount = finalisedCount + 1 %}
                                {% endif %}
                            {% endfor %}
                            {% for reservation in AwaitingStatus %}
                                {% if reservation.product.id == product.id %}
                                    {% set awaitingCount = awaitingCount + 1 %}
                                {% endif %}
                            {% endfor %}
                            {% for reservation in ConfirmedStatus %}
                                {% if (reservation.product.id == product.id) and (reservation.isCompleted == 0) %}
                                    {% set confirmedCount = confirmedCount + 1 %}
                                {% endif %}
                            {% endfor %}
                            {% for reservation in CancelledStatus %}
                                {% if reservation.product.id == product.id %}
                                    {% set cancelledCount = cancelledCount + 1 %}
                                {% endif %}
                            {% endfor %}
                            <div class="accordion-item mb-3">
                                <h2 class="accordion-header" id="heading-{{ product.id }}">
                                    <button class="accordion-button collapsed fw-bold" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-{{ product.id }}" aria-expanded="false" aria-controls="collapse-{{ product.id }}">
                                        <span class="me-3">üè†</span> {{ product.name }}
                                        {% if product.reservations|length > 0 %}
                                            <span class="badge bg-primary ms-3">{{ product.reservations|length }} r√©servations</span>&nbsp; dont
                                        {% endif %}
                                        {% if awaitingCount > 0 %}
                                            <span class="badge bg-danger ms-3">{{ awaitingCount }} r√©servations en attente</span>
                                        {% endif %}
                                        {% if confirmedCount > 0 %}
                                            <span class="badge bg-success ms-3">{{ confirmedCount }} r√©servations confirm√©es</span>
                                        {% endif %}
                                        {% if cancelledCount > 0 %}
                                            <span class="badge bg-secondary ms-3">{{ cancelledCount }} r√©servations annul√©es</span>
                                        {% endif %}
                                        {% if finalisedCount > 0 %}
                                            <span class="badge bg-dark ms-3">{{ finalisedCount }} r√©servations finalis√©es </span>
                                        {% endif %}
                                    </button>
                                </h2>
                                <div id="collapse-{{ product.id }}" class="accordion-collapse collapse" aria-labelledby="heading-{{ product.id }}" data-bs-parent="#accordionProducts">
                                    <div class="accordion-body">
                                        <div class="mb-2">
                                            <strong>Nombre de r√©servations dans l'historique complet :</strong> {{ product.reservations|length }}
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-md-4"><strong>Ville :</strong> {{ product.city }}</div>
                                            <div class="col-md-4"><strong>D√©partement :</strong> {{ product.departement }}</div>
                                            <div class="col-md-4"><strong>Surface :</strong> {{ product.surface }} m¬≤</div>
                                        </div>
                                        <div class="row mb-2">
                                            <div class="col-md-4"><strong>Couchages :</strong> {{ product.couchages }}</div>
                                            <div class="col-md-4"><strong>Prix par nuit :</strong> {{ product.price }} ‚Ç¨</div>
                                            <div class="col-md-4"><strong>Disponible :</strong> {{ product.isAvailable ? 'Oui' : 'Non' }}</div>
                                        </div>
                                        <div class="mb-2">
                                            <strong>Sous-cat√©gories :</strong>
                                            {% for sub in product.subCategory %}
                                                {{ sub.name }}{% if not loop.last %}, {% endif %}
                                            {% else %}
                                                <span class="text-muted">Aucune</span>
                                            {% endfor %}
                                        </div>
                                        <hr>
                                        <div class="mb-2">
                                            <strong>R√©servations en attente :</strong> {{ awaitingCount }}
                                        </div>
                                        <ul>
                                            {% for reservation in AwaitingStatus %}
                                                {% if reservation.product.id == product.id %}
                                                    <li class="border-bottom pb-2 mb-2">
                                                        R√©servation ID: {{ reservation.id }} - 
                                                        pour un s√©jour du {{ reservation.startDate|date('d/m/Y') }} au {{ reservation.endDate|date('d/m/Y') }}<br>
                                                        r√©servation fa√Æte le {{ reservation.createdAT|date('d/m/Y H:i:s', 'Europe/Paris') }}
                                                        {% if reservation.user %}
                                                            par {{ reservation.user.firstName }} {{ reservation.user.lastName }} - {{ reservation.user.email }}
                                                        {% endif %}
                                                    </li>
                                                    <a class="btn btn-outline-danger btn-sm ms-auto" href="{{ path('reservation_cancel', {'id': reservation.id}) }}">Annuler la r√©servation</a>
                                                    {# <a class="btn btn-outline-primary btn-sm ms-auto" href="{{ path('app_devis', {'id': reservation.id}) }}">G√©n√©rer le devis</a> #}
                                                {% endif %}
                                            {% endfor %}
                                        </ul>

                                        <div class="mb-2">
                                            <strong>R√©servations confirm√©es :</strong> {{ confirmedCount }}
                                        </div>
                                        <ul>
                                            {% for reservation in ConfirmedStatus %}
                                                {% if (reservation.product.id == product.id) and (reservation.isCompleted == 0) %}
                                                    <li class="border-bottom pb-2 mb-2">
                                                        R√©servation ID: {{ reservation.id }} - 
                                                        pour un s√©jour du {{ reservation.startDate|date('d/m/Y') }} au {{ reservation.endDate|date('d/m/Y') }}<br>
                                                        r√©servation fa√Æte le {{ reservation.createdAT|date('d/m/Y H:i:s', 'Europe/Paris') }}
                                                        {% if reservation.user %}
                                                            par {{ reservation.user.firstName }} {{ reservation.user.lastName }} - {{ reservation.user.email }}
                                                        {% endif %} <br>
                                                        r√©servation confirm√©e le {{ reservation.confirmedAt|date('d/m/Y H:i:s', 'Europe/Paris') }} par {{ reservation.confirmedBy.firstName }} {{ reservation.confirmedBy.lastName }}
                                                    </li>
                                                    <a class="btn btn-outline-danger btn-sm ms-auto" href="{{ path('reservation_cancel', {'id': reservation.id}) }}">Annuler la r√©servation</a>
                                                    {# <a class="btn btn-outline-primary btn-sm ms-auto" href="{{ path('app_deposit_bill', {'id': reservation.id}) }}">G√©n√©rer la facture d'accompte</a> #}
                                                {% endif %}
                                            {% endfor %}
                                        </ul>
            
                                        <div class="mb-2">
                                            <strong>R√©servations annul√©es :</strong> {{ cancelledCount }}
                                        </div>
                                        <ul>
                                            {% for reservation in CancelledStatus %}
                                                {% if reservation.product.id == product.id %}
                                                    <li  class=" border-bottom pb-2 mb-2">
                                                        R√©servation ID: {{ reservation.id }} - 
                                                        pour un s√©jour du {{ reservation.startDate|date('d/m/Y') }} au {{ reservation.endDate|date('d/m/Y') }}<br>
                                                        r√©servation fa√Æte le {{ reservation.createdAT|date('d/m/Y H:i:s', 'Europe/Paris') }}
                                                        {% if reservation.user %}
                                                            par {{ reservation.user.firstName }} {{ reservation.user.lastName }} - {{ reservation.user.email }}
                                                        {% endif %} <br>
                                                        r√©servation annul√©e le {{ reservation.cancelledAt|date('d/m/Y H:i:s', 'Europe/Paris') }} par {{ reservation.cancelledBy.firstName }} {{ reservation.cancelledBy.lastName }}
                                                    </li>
                                                {% endif %}
                                            {% endfor %}
                                        </ul>

                                        <div class="mb-2">
                                            <strong>R√©servations finalis√©es : </strong> {{ finalisedCount }}
                                        </div>
                                        <ul>
                                            {% for reservation in FinalisedStatus %}
                                                {% if reservation.product.id == product.id %}
                                                    <li class="border-bottom pb-2 mb-2">
                                                        R√©servation ID: {{ reservation.id }} -
                                                        pour un s√©jour du {{ reservation.startDate|date('d/m/Y') }} au {{ reservation.endDate|date('d/m/y') }} <br>
                                                        r√©servation fa√Æte le {{ reservation.createdAT|date('d/m/Y H:i:s', 'Europe/Paris') }}
                                                        {% if reservation.user %}
                                                            par {{ reservation.user.firstName }} {{ reservation.user.lastName }} - {{ reservation.user.email }}
                                                        {% endif %} <br>
                                                        r√©servation confirm√©e le {{ reservation.confirmedAt|date('d/m/Y H:i:s', 'Europe/Paris') }} par {{ reservation.confirmedBy.firstName }} {{ reservation.confirmedBy.lastName }}
                                                    </li>
                                                    {# <a class="btn btn-outline-primary btn-sm ms-auto" href="{{ path('app_bill', {'id': reservation.id}) }}">G√©n√©rer la facture</a> #}
                                                {% endif %}
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                        <div class="d-flex justify-content-center ">
                            {{ knp_pagination_render(pagination) }}
                        </div>
                    </div>
                </div>    
            </div>
        </div>
    </div>
{% endblock %}